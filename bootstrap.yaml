admin:
  accessLogPath: /dev/null
  address:
    socketAddress:
      address: 0.0.0.0
      portValue: 19000
staticResources:
  clusters:
  - name: upstream
    connectTimeout: 1s
    dnsLookupFamily: V4_ONLY
    hosts:
    - socketAddress:
        address: httpbin.org
        portValue: 443
    tlsContext:
      sni: httpbin.org
    type: LOGICAL_DNS
  - name: authn-service
    connectTimeout: 1s
    hosts:
    - socketAddress:
        address: 127.0.0.1
        portValue: 8899
  listeners:
  - name: upstream
    address:
      socketAddress:
        address: 0.0.0.0
        portValue: 8080
    filterChains:
    - filters:
      - name: envoy.http_connection_manager
        config:
          statPrefix: ingress_http
          httpFilters:
          - name: envoy.filters.http.wasm
            config:
              config:
                configuration: authn-service
                name: authz-filter
                rootId: authz-filter
                vmConfig:
                  code:
                    local:
                      filename: build/optimized.wasm
                  runtime: envoy.wasm.runtime.v8
          - name: envoy.router
          routeConfig:
            name: upstream_route
            virtualHosts:
            - name: upstream_service
              domains:
              - '*'
              routes:
              - match:
                  prefix: /
                route:
                  autoHostRewrite: true
                  cluster: upstream
  - name: authn-service
    address:
      socketAddress:
        address: 127.0.0.1
        portValue: 8899
    filterChains:
    - filters:
      - name: envoy.http_connection_manager
        config:
          statPrefix: ingress_http
          httpFilters:
          - name: envoy.router
          routeConfig:
            name: local_route
            virtualHosts:
            - name: local_service
              domains:
              - '*'
              routes:
              - match:
                  prefix: /anything/failure
                direct_response:
                  status: 403
                  body:
                    inline_string: "not ok\n"
              - match:
                  prefix: /
                direct_response:
                  status: 200
                  body:
                    inline_string: "ok\n"
